name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-showmethemoney
  ACR_RESOURCE_GROUP: rg-smtm
  LOCATION: koreacentral
  ENVIRONMENT: dev
  APP_NAME: showmethemoney
  ACR_NAME: acrsmtm
  # ACR_LOGIN_SERVERëŠ” ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜´

jobs:
  setup-infrastructure:
    name: Setup Azure Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    outputs:
      acr_login_server: ${{ steps.publish_outputs.outputs.acr_login_server }}
      acr_name: ${{ steps.publish_outputs.outputs.acr_name }}
      backend_url: ${{ steps.publish_outputs.outputs.backend_url }}
      frontend_url: ${{ steps.publish_outputs.outputs.frontend_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: Install Container Apps Extension
        run: |
          az extension add --name containerapp --upgrade

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }}

      - name: Use Existing Container Registry
        id: create_acr
        run: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì‚¬ìš©
          ACR_NAME="${{ env.ACR_NAME }}"
          ACR_RG="${{ env.ACR_RESOURCE_GROUP }}"
          
          echo "âœ… Using existing Container Registry: $ACR_NAME"
          echo "   Resource Group: $ACR_RG"
          
          # ê¸°ì¡´ ACR ì¡´ìž¬ ì—¬ë¶€ ë° ì ‘ê·¼ ê¶Œí•œ í™•ì¸
          if ! az acr show --name $ACR_NAME --resource-group $ACR_RG 2>/dev/null; then
            echo "âŒ Error: Container Registry '$ACR_NAME' not found in resource group '$ACR_RG'"
            echo "Please ensure the ACR exists and the service principal has access to it."
            exit 1
          fi
          
          # ACR ë¡œê·¸ì¸ ì„œë²„ ê°€ì ¸ì˜¤ê¸°
          ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $ACR_RG --query loginServer -o tsv)
          echo "   Login Server: $ACR_LOGIN_SERVER"
          
          # ACR ì¸ì¦ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì ‘ê·¼ ê¶Œí•œ ê²€ì¦)
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group $ACR_RG --query username -o tsv 2>/dev/null)
          if [ -z "$ACR_USERNAME" ]; then
            echo "âŒ Error: Unable to retrieve ACR credentials."
            echo "Please ensure admin user is enabled and you have permission to access it."
            exit 1
          fi
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group $ACR_RG --query passwords[0].value -o tsv)
          
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Create Log Analytics Workspace
        id: create_log_workspace
        run: |
          LOG_WORKSPACE_NAME="log-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          if ! az monitor log-analytics workspace show --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name $LOG_WORKSPACE_NAME 2>/dev/null; then
            az monitor log-analytics workspace create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --workspace-name $LOG_WORKSPACE_NAME \
              --location ${{ env.LOCATION }}
          fi

          LOG_CUSTOMER_ID=$(az monitor log-analytics workspace show --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name $LOG_WORKSPACE_NAME --query customerId -o tsv)
          LOG_SHARED_KEY=$(az monitor log-analytics workspace get-shared-keys --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name $LOG_WORKSPACE_NAME --query primarySharedKey -o tsv)

          echo "workspace_name=$LOG_WORKSPACE_NAME" >> $GITHUB_OUTPUT
          echo "customer_id=$LOG_CUSTOMER_ID" >> $GITHUB_OUTPUT
          echo "shared_key=$LOG_SHARED_KEY" >> $GITHUB_OUTPUT

      - name: Create Application Insights
        id: create_app_insights
        run: |
          APPINSIGHTS_NAME="appi-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          if ! az monitor app-insights component show --app $APPINSIGHTS_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
            az monitor app-insights component create \
              --app $APPINSIGHTS_NAME \
              --location ${{ env.LOCATION }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --workspace ${{ steps.create_log_workspace.outputs.workspace_name }}
          fi

          CONNECTION_STRING=$(az monitor app-insights component show --app $APPINSIGHTS_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query connectionString -o tsv)

          echo "appinsights_name=$APPINSIGHTS_NAME" >> $GITHUB_OUTPUT
          echo "connection_string=$CONNECTION_STRING" >> $GITHUB_OUTPUT

      - name: Create Container Apps Environment
        id: create_container_env
        run: |
          CONTAINERAPP_ENV_NAME="cae-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          LOG_CUSTOMER_ID="${{ steps.create_log_workspace.outputs.customer_id }}"
          LOG_SHARED_KEY="${{ steps.create_log_workspace.outputs.shared_key }}"

          if ! az containerapp env show --name $CONTAINERAPP_ENV_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
            az containerapp env create \
              --name $CONTAINERAPP_ENV_NAME \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --location ${{ env.LOCATION }} \
              --logs-workspace-id $LOG_CUSTOMER_ID \
              --logs-workspace-key $LOG_SHARED_KEY
          fi

          echo "container_env_name=$CONTAINERAPP_ENV_NAME" >> $GITHUB_OUTPUT

      - name: Create Backend Container App
        id: create_backend_app
        run: |
          BACKEND_APP_NAME="ca-${{ env.APP_NAME }}-backend-${{ env.ENVIRONMENT }}"
          ACR_LOGIN_SERVER="${{ steps.create_acr.outputs.login_server }}"
          ACR_NAME="${{ steps.create_acr.outputs.acr_name }}"
          APPINSIGHTS_CONNECTION_STRING="${{ steps.create_app_insights.outputs.connection_string }}"
          CONTAINERAPP_ENV_NAME="${{ steps.create_container_env.outputs.container_env_name }}"

          if ! az containerapp show --name $BACKEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
            # í”„ë¡ íŠ¸ì—”ë“œ FQDNì„ ë¯¸ë¦¬ ì˜ˆì¸¡ (í›„ì— ì—…ë°ì´íŠ¸ ê°€ëŠ¥)
            FRONTEND_FQDN="ca-${{ env.APP_NAME }}-frontend-${{ env.ENVIRONMENT }}.bravewater-46e243b4.koreacentral.azurecontainerapps.io"
            
            az containerapp create \
              --name $BACKEND_APP_NAME \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment $CONTAINERAPP_ENV_NAME \
              --image mcr.microsoft.com/azuredocs/containerapps-helloworld:latest \
              --target-port 8000 \
              --ingress external \
              --registry-server $ACR_LOGIN_SERVER \
              --system-assigned \
              --secrets \
                appinsights-connection-string="$APPINSIGHTS_CONNECTION_STRING" \
                github-token="${{ secrets.GITHUB_TOKEN }}" \
              --env-vars \
                APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string \
                GITHUB_TOKEN=secretref:github-token \
                GITHUB_REPO_OWNER=dotnetpower \
                GITHUB_REPO_NAME=showmethemoney \
                CORS_ORIGINS="https://${FRONTEND_FQDN},http://localhost:3000,http://localhost:5173" \
              --cpu 0.5 \
              --memory 1Gi \
              --min-replicas 1 \
              --max-replicas 3

            # Get the managed identity principal ID
            PRINCIPAL_ID=$(az containerapp show --name $BACKEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query identity.principalId -o tsv)
            
            # Grant AcrPull role to the managed identity
            ACR_ID=$(az acr show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query id -o tsv)
            az role assignment create --assignee $PRINCIPAL_ID --role AcrPull --scope $ACR_ID
          fi

          BACKEND_FQDN=$(az containerapp show --name $BACKEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)

          echo "backend_app_name=$BACKEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "backend_fqdn=$BACKEND_FQDN" >> $GITHUB_OUTPUT

      - name: Create Frontend Container App
        id: create_frontend_app
        run: |
          FRONTEND_APP_NAME="ca-${{ env.APP_NAME }}-frontend-${{ env.ENVIRONMENT }}"
          ACR_LOGIN_SERVER="${{ steps.create_acr.outputs.login_server }}"
          ACR_NAME="${{ steps.create_acr.outputs.acr_name }}"
          CONTAINERAPP_ENV_NAME="${{ steps.create_container_env.outputs.container_env_name }}"
          BACKEND_FQDN="${{ steps.create_backend_app.outputs.backend_fqdn }}"

          if ! az containerapp show --name $FRONTEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
            az containerapp create \
              --name $FRONTEND_APP_NAME \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment $CONTAINERAPP_ENV_NAME \
              --image mcr.microsoft.com/azuredocs/containerapps-helloworld:latest \
              --target-port 80 \
              --ingress external \
              --registry-server $ACR_LOGIN_SERVER \
              --system-assigned \
              --env-vars \
                REACT_APP_API_URL="https://${BACKEND_FQDN}" \
              --cpu 0.5 \
              --memory 1Gi \
              --min-replicas 1 \
              --max-replicas 5

            # Get the managed identity principal ID
            PRINCIPAL_ID=$(az containerapp show --name $FRONTEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query identity.principalId -o tsv)
            
            # Grant AcrPull role to the managed identity
            ACR_ID=$(az acr show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query id -o tsv)
            az role assignment create --assignee $PRINCIPAL_ID --role AcrPull --scope $ACR_ID
          fi

          FRONTEND_FQDN=$(az containerapp show --name $FRONTEND_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)

          echo "frontend_app_name=$FRONTEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "frontend_fqdn=$FRONTEND_FQDN" >> $GITHUB_OUTPUT

      - name: Publish Outputs
        id: publish_outputs
        run: |
          ACR_NAME="${{ steps.create_acr.outputs.acr_name }}"
          ACR_LOGIN_SERVER="${{ steps.create_acr.outputs.login_server }}"
          BACKEND_FQDN="${{ steps.create_backend_app.outputs.backend_fqdn }}"
          FRONTEND_FQDN="${{ steps.create_frontend_app.outputs.frontend_fqdn }}"
          
          echo "Publishing outputs:"
          echo "  ACR Name: $ACR_NAME"
          echo "  ACR Login Server: $ACR_LOGIN_SERVER"
          echo "  Backend FQDN: $BACKEND_FQDN"
          echo "  Frontend FQDN: $FRONTEND_FQDN"
          
          echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "backend_url=https://$BACKEND_FQDN" >> $GITHUB_OUTPUT
          echo "frontend_url=https://$FRONTEND_FQDN" >> $GITHUB_OUTPUT

  build-and-push-backend:
    name: Build and Push Backend Image
    runs-on: ubuntu-latest
    needs: setup-infrastructure
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: ACR Login
        run: |
          az acr login --name ${{ needs.setup-infrastructure.outputs.acr_name }}

      - name: Build and Push Backend Image
        run: |
          echo "Building backend image with data directory..."
          ls -la data/ | head -10
          
          docker build -t ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:${{ github.sha }} \
            -t ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:latest \
            -f backend/Dockerfile .
          
          # Verify data is in the image
          echo "Verifying data directory in image..."
          docker run --rm ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:latest ls -la /app/data | head -10
          
          docker push ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:${{ github.sha }}
          docker push ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:latest

  build-and-push-frontend:
    name: Build and Push Frontend Image
    runs-on: ubuntu-latest
    needs: setup-infrastructure
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: ACR Login
        run: |
          ACR_NAME="${{ needs.setup-infrastructure.outputs.acr_name }}"
          if [ -z "$ACR_NAME" ]; then
            echo "âŒ Error: ACR name is empty"
            echo "Available outputs: acr_name=$ACR_NAME"
            exit 1
          fi
          echo "Logging into ACR: $ACR_NAME"
          az acr login --name "$ACR_NAME"

      - name: Build and Push Frontend Image
        run: |
          # ë°±ì—”ë“œ URL ì„¤ì •
          BACKEND_URL="https://ca-${{ env.APP_NAME }}-backend-${{ env.ENVIRONMENT }}.bravewater-46e243b4.koreacentral.azurecontainerapps.io"
          
          docker build -t ${{ needs.setup-infrastructure.outputs.acr_login_server }}/frontend:${{ github.sha }} \
            -t ${{ needs.setup-infrastructure.outputs.acr_login_server }}/frontend:latest \
            --build-arg VITE_API_BASE_URL="$BACKEND_URL" \
            -f frontend/Dockerfile ./frontend
          docker push ${{ needs.setup-infrastructure.outputs.acr_login_server }}/frontend:${{ github.sha }}
          docker push ${{ needs.setup-infrastructure.outputs.acr_login_server }}/frontend:latest

  deploy-backend:
    name: Deploy Backend to Container Apps
    runs-on: ubuntu-latest
    needs: [setup-infrastructure, build-and-push-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: Deploy Backend Container App
        run: |
          ACR_NAME="${{ needs.setup-infrastructure.outputs.acr_name }}"
          ACR_LOGIN_SERVER="${{ needs.setup-infrastructure.outputs.acr_login_server }}"
          
          # ACR ì¸ì¦ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query passwords[0].value -o tsv)
          
          # Registry ì„¤ì • (ì´ë¯¸ ì„¤ì •ë˜ì–´ ìžˆìœ¼ë©´ ì—ëŸ¬ ë¬´ì‹œ)
          az containerapp registry set \
            --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --server $ACR_LOGIN_SERVER \
            --username $ACR_USERNAME \
            --password $ACR_PASSWORD || true
          
          # Container App ì—…ë°ì´íŠ¸
          # í”„ë¡ íŠ¸ì—”ë“œ FQDN ê°€ì ¸ì˜¤ê¸°
          FRONTEND_FQDN=$(az containerapp show --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || echo "ca-${{ env.APP_NAME }}-frontend-${{ env.ENVIRONMENT }}.bravewater-46e243b4.koreacentral.azurecontainerapps.io")
          
          az containerapp update \
            --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ needs.setup-infrastructure.outputs.acr_login_server }}/backend:${{ github.sha }} \
            --set-env-vars \
              APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string \
              GITHUB_TOKEN=secretref:github-token \
              GITHUB_REPO_OWNER=dotnetpower \
              GITHUB_REPO_NAME=showmethemoney \
              CORS_ORIGINS="https://${FRONTEND_FQDN},http://localhost:3000,http://localhost:5173"
          
          # Ingress ì„¤ì • í™•ì¸ ë° ì—…ë°ì´íŠ¸
          az containerapp ingress update \
            --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --target-port 8000 \
            --type external

  deploy-frontend:
    name: Deploy Frontend to Container Apps
    runs-on: ubuntu-latest
    needs: [setup-infrastructure, build-and-push-frontend, deploy-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: Deploy Frontend Container App
        run: |
          ACR_NAME="${{ needs.setup-infrastructure.outputs.acr_name }}"
          ACR_LOGIN_SERVER="${{ needs.setup-infrastructure.outputs.acr_login_server }}"
          
          # ACR ì¸ì¦ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query passwords[0].value -o tsv)
          
          # Registry ì„¤ì • (ì´ë¯¸ ì„¤ì •ë˜ì–´ ìžˆìœ¼ë©´ ì—ëŸ¬ ë¬´ì‹œ)
          az containerapp registry set \
            --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --server $ACR_LOGIN_SERVER \
            --username $ACR_USERNAME \
            --password $ACR_PASSWORD || true
          
          # ë°±ì—”ë“œ FQDN ê°€ì ¸ì˜¤ê¸°
          BACKEND_FQDN=$(az containerapp show --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
          
          # Container App ì—…ë°ì´íŠ¸
          az containerapp update \
            --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ needs.setup-infrastructure.outputs.acr_login_server }}/frontend:${{ github.sha }} \
            --set-env-vars \
              REACT_APP_API_URL="https://${BACKEND_FQDN}"
          
          # Ingress ì„¤ì • í™•ì¸ ë° ì—…ë°ì´íŠ¸
          az containerapp ingress update \
            --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --target-port 80 \
            --type external

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Azure CLI Login
        shell: bash
        run: |
          set -euo pipefail
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          CLIENT_ID=$(echo "$CREDS" | jq -r '.clientId')
          CLIENT_SECRET=$(echo "$CREDS" | jq -r '.clientSecret')
          TENANT_ID=$(echo "$CREDS" | jq -r '.tenantId')
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          az login --service-principal -u "$CLIENT_ID" -p "$CLIENT_SECRET" --tenant "$TENANT_ID" >/dev/null
          az account set --subscription "$SUBSCRIPTION_ID"

      - name: Check Backend Health
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "Backend URL: https://${BACKEND_URL}"
          
          # Health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${BACKEND_URL}/health || echo "000")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Backend health check failed with status: $HTTP_STATUS"
            exit 1
          fi
          echo "Backend is healthy"

      - name: Check Frontend Health
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "Frontend URL: https://${FRONTEND_URL}"
          
          # Health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${FRONTEND_URL} || echo "000")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Frontend health check failed with status: $HTTP_STATUS"
            exit 1
          fi
          echo "Frontend is healthy"

      - name: Display Deployment URLs
        run: |
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          SUBSCRIPTION_ID=$(echo "$CREDS" | jq -r '.subscriptionId')
          echo "ðŸš€ Deployment Complete!"
          echo "Backend: https://$(az containerapp show --name ca-showmethemoney-backend-${{ env.ENVIRONMENT }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)"
          echo "Frontend: https://$(az containerapp show --name ca-showmethemoney-frontend-${{ env.ENVIRONMENT }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)"
          echo "Resource Group: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${{ env.RESOURCE_GROUP }}/overview"
